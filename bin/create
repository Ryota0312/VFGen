#!./env/bin/python3
## 仮想フォルダの生成
import yaml
import os
import datetime
import shutil
import sys
app_home = os.path.abspath(os.path.join( os.path.dirname(os.path.abspath(__file__)) , ".." ))

# 設定ファイルのロード
try:
    settings = yaml.load(open(app_home + '/settings.yml','r'), Loader=yaml.SafeLoader)
except:
    print("Error: Cannnot open log file. Check your settings.")
    sys.exit()

dst = settings["DST"]
f = open(settings["SRC"])
wds = {}
for i, l in enumerate(f):
    if i==0: continue
    src = l.replace("\n", "")
    srcl = src.split(",", 1)
    wds[srcl[0]] = eval(srcl[1])

## 使用時期別
year = 2019
recent_path = "./" + dst + "/RecentWDs/"
if os.path.exists(recent_path): shutil.rmtree(recent_path)
if not os.path.exists(recent_path): os.makedirs(recent_path)
for m in range(1,13):
    for d in wds.keys():
        if dst in d: continue
        for at in wds[d]:
            # 月別
            if at[0].month <= m and at[1].month >= m:
                path = "./" + dst + "/" + str(year) + "/" + str(m).rjust(2, '0')
                if not os.path.exists(path): os.makedirs(path)
                if not os.path.exists(path + "/" + d.split("/")[-1]): os.symlink(d, path + "/" + d.split("/")[-1])
            # 最近
            if at[0] > (datetime.datetime.now() - datetime.timedelta(days=21)):
                if not os.path.exists(recent_path + "/" + d.split("/")[-1]): os.symlink(d, recent_path + "/" + d.split("/")[-1])
    
